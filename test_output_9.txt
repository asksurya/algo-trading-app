============================= test session starts ==============================
platform darwin -- Python 3.12.1, pytest-9.0.1, pluggy-1.6.0
rootdir: /Users/ashwin/Desktop/algo-trading-app/backend
configfile: pytest.ini
plugins: anyio-4.11.0, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1 item

backend/tests/test_backtesting_e2e.py F                                  [100%]

=================================== FAILURES ===================================
____________________________ test_backtest_e2e_flow ____________________________

backtest_data = BacktestCreate(strategy_id=UUID('3b5a6475-b1df-4439-bc15-bbb0a2aaaf9b'), name='E2E Backtest', description=None, start_...date=datetime.datetime(2023, 1, 31, 0, 0), initial_capital=10000.0, commission=0.0, slippage=0.0, strategy_params=None)
session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x11cebb9b0>
current_user = <[MissingGreenlet("greenlet_spawn has not been called; can't call await_only() here. Was IO attempted in an unexpected place?") raised in repr()] User object at 0x11cf6e900>

    @router.post("", status_code=status.HTTP_201_CREATED)
    async def create_backtest(
        backtest_data: BacktestCreate,
        session: AsyncSession = Depends(get_db),
        current_user: User = Depends(get_current_user),
    ):
        """
        Create and queue a new backtest.
    
        The backtest will be created with status='pending' and can be executed
        by calling the run endpoint or automatically by a background worker.
        """
        # Check if strategy exists and belongs to user
        result = await session.execute(
            select(Strategy).where(
                Strategy.id == str(backtest_data.strategy_id),
                Strategy.user_id == current_user.id
            )
        )
        strategy = result.scalar_one_or_none()
        print(f"DEBUG: Found strategy: {strategy}")
    
        if not strategy:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Strategy not found"
            )
    
        # Create backtest
        backtest = Backtest(
            user_id=current_user.id,
            strategy_id=strategy.id,
            name=backtest_data.name,
            description=backtest_data.description,
            start_date=backtest_data.start_date,
            end_date=backtest_data.end_date,
            initial_capital=backtest_data.initial_capital,
            commission=backtest_data.commission,
            slippage=backtest_data.slippage,
            strategy_params=backtest_data.strategy_params,
        )
    
        session.add(backtest)
        await session.commit()
        await session.refresh(backtest)
    
        # Run backtest asynchronously
        try:
            runner = BacktestRunner(session)
>           result = await runner.run_backtest(backtest.id)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

backend/app/api/v1/backtests.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
backend/app/backtesting/runner.py:74: in run_backtest
    results = await self._execute_backtest(
backend/app/backtesting/runner.py:130: in _execute_backtest
    strategy_instance = self._create_strategy_instance(strategy_model)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
backend/app/backtesting/runner.py:170: in _create_strategy_instance
    strategy_type = strategy_model.strategy_type.lower()
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:569: in __get__
    return self.impl.get(state, dict_)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:1096: in get
    value = self._fire_loader_callables(state, key, passive)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:1126: in _fire_loader_callables
    return state._load_expired(state, passive)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/state.py:803: in _load_expired
    self.manager.expired_attribute_loader(self, toload, passive)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/loading.py:1674: in load_scalar_attributes
    result = load_on_ident(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/loading.py:510: in load_on_ident
    return load_on_pk_identity(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/loading.py:695: in load_on_pk_identity
    session.execute(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:157: in execute
    _cursor: AsyncIODBAPICursor = self.await_(self._connection.cursor())  # type: ignore[arg-type] # noqa: E501
                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

awaitable = <aiosqlite.context.Result object at 0x11d3dea10>

    def await_only(awaitable: Awaitable[_T]) -> _T:
        """Awaits an async function in a sync method.
    
        The sync method must be inside a :func:`greenlet_spawn` context.
        :func:`await_only` calls cannot be nested.
    
        :param awaitable: The coroutine to call.
    
        """
        # this is called in the context greenlet while running fn
        current = getcurrent()
        if not getattr(current, "__sqlalchemy_greenlet_provider__", False):
            _safe_cancel_awaitable(awaitable)
    
>           raise exc.MissingGreenlet(
                "greenlet_spawn has not been called; can't call await_only() "
                "here. Was IO attempted in an unexpected place?"
            )
E           sqlalchemy.exc.MissingGreenlet: greenlet_spawn has not been called; can't call await_only() here. Was IO attempted in an unexpected place? (Background on this error at: https://sqlalche.me/e/20/xd2s)

../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:123: MissingGreenlet

The above exception was the direct cause of the following exception:

client = <httpx.AsyncClient object at 0x11d04fb60>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxZmRmMDk4ZS03MzU4LTQyNmItOGJkNy05ODIzM2E4NDYxY2YiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzY1NDI2NzY3fQ.5jYnjvxT9Ue7HQqpSN9tOv4iWiKdxk9eokUr5MIApAg'}
mock_market_data_cache = <MagicMock name='MarketDataCacheService()' id='4783701408'>

    @pytest.mark.asyncio
    async def test_backtest_e2e_flow(client, auth_headers, mock_market_data_cache):
        """
        Test the full backtesting flow:
        1. Create a strategy
        2. Create and run a backtest
        3. Verify results
        """
    
        # 1. Create Strategy
        strategy_data = {
            "name": "E2E Test Strategy",
            "description": "Test Strategy",
            "strategy_type": "sma_crossover",
            "parameters": {
                "symbol": "AAPL",
                "short_window": 10,
                "long_window": 20
            }
        }
    
        response = await client.post(
            "/api/v1/strategies",
            json=strategy_data,
            headers=auth_headers
        )
        assert response.status_code == 201
        strategy_id = response.json()["id"]
    
        # 2. Create and Run Backtest
        backtest_data = {
            "strategy_id": strategy_id,
            "name": "E2E Backtest",
            "start_date": "2023-01-01",
            "end_date": "2023-01-31",
            "initial_capital": 10000.0,
            "commission": 0.0,
            "slippage": 0.0
        }
    
>       response = await client.post(
            "/api/v1/backtests",
            json=backtest_data,
            headers=auth_headers
        )

backend/tests/test_backtesting_e2e.py:67: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/fastapi/applications.py:1134: in __call__
    await super().__call__(scope, receive, send)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../.pyenv/versions/3.12.1/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
backend/app/main.py:82: in add_security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../.pyenv/versions/3.12.1/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/slowapi/middleware.py:136: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/fastapi/routing.py:125: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/fastapi/routing.py:111: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/fastapi/routing.py:391: in app
    raw_response = await run_endpoint_function(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/fastapi/routing.py:290: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
backend/app/api/v1/backtests.py:94: in create_backtest
    "id": str(backtest.id),
              ^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:569: in __get__
    return self.impl.get(state, dict_)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:1096: in get
    value = self._fire_loader_callables(state, key, passive)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:1126: in _fire_loader_callables
    return state._load_expired(state, passive)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/state.py:803: in _load_expired
    self.manager.expired_attribute_loader(self, toload, passive)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/loading.py:1674: in load_scalar_attributes
    result = load_on_ident(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/loading.py:510: in load_on_ident
    return load_on_pk_identity(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/loading.py:695: in load_on_pk_identity
    session.execute(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:157: in execute
    _cursor: AsyncIODBAPICursor = self.await_(self._connection.cursor())  # type: ignore[arg-type] # noqa: E501
                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

awaitable = <aiosqlite.context.Result object at 0x11d5d0950>

    def await_only(awaitable: Awaitable[_T]) -> _T:
        """Awaits an async function in a sync method.
    
        The sync method must be inside a :func:`greenlet_spawn` context.
        :func:`await_only` calls cannot be nested.
    
        :param awaitable: The coroutine to call.
    
        """
        # this is called in the context greenlet while running fn
        current = getcurrent()
        if not getattr(current, "__sqlalchemy_greenlet_provider__", False):
            _safe_cancel_awaitable(awaitable)
    
>           raise exc.MissingGreenlet(
                "greenlet_spawn has not been called; can't call await_only() "
                "here. Was IO attempted in an unexpected place?"
            )
E           sqlalchemy.exc.MissingGreenlet: greenlet_spawn has not been called; can't call await_only() here. Was IO attempted in an unexpected place? (Background on this error at: https://sqlalche.me/e/20/xd2s)

../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:123: MissingGreenlet
----------------------------- Captured stdout call -----------------------------
payload from token: {'sub': '1fdf098e-7358-426b-8bd7-98233a8461cf', 'type': 'access', 'exp': 1765426767}
user_id from token: 1fdf098e-7358-426b-8bd7-98233a8461cf
payload from token: {'sub': '1fdf098e-7358-426b-8bd7-98233a8461cf', 'type': 'access', 'exp': 1765426767}
user_id from token: 1fdf098e-7358-426b-8bd7-98233a8461cf
DEBUG: Found strategy: <Strategy(id=3b5a6475-b1df-4439-bc15-bbb0a2aaaf9b, name=E2E Test Strategy, type=sma_crossover)>
------------------------------ Captured log call -------------------------------
ERROR    app.backtesting.runner:runner.py:111 Backtest 6ec2d4b7-0edc-4ccc-a8f6-5e918fa0b8be failed: greenlet_spawn has not been called; can't call await_only() here. Was IO attempted in an unexpected place? (Background on this error at: https://sqlalche.me/e/20/xd2s)
Traceback (most recent call last):
  File "/Users/ashwin/Desktop/algo-trading-app/backend/app/backtesting/runner.py", line 74, in run_backtest
    results = await self._execute_backtest(
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ashwin/Desktop/algo-trading-app/backend/app/backtesting/runner.py", line 130, in _execute_backtest
    strategy_instance = self._create_strategy_instance(strategy_model)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ashwin/Desktop/algo-trading-app/backend/app/backtesting/runner.py", line 170, in _create_strategy_instance
    strategy_type = strategy_model.strategy_type.lower()
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py", line 569, in __get__
    return self.impl.get(state, dict_)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py", line 1096, in get
    value = self._fire_loader_callables(state, key, passive)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py", line 1126, in _fire_loader_callables
    return state._load_expired(state, passive)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/state.py", line 803, in _load_expired
    self.manager.expired_attribute_loader(self, toload, passive)
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/loading.py", line 1674, in load_scalar_attributes
    result = load_on_ident(
             ^^^^^^^^^^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/loading.py", line 510, in load_on_ident
    return load_on_pk_identity(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/loading.py", line 695, in load_on_pk_identity
    session.execute(
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2249, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/orm/context.py", line 306, in orm_execute_statement
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2358, in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 180, in execute
    self._adapt_connection._handle_exception(error)
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 340, in _handle_exception
    raise error
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 157, in execute
    _cursor: AsyncIODBAPICursor = self.await_(self._connection.cursor())  # type: ignore[arg-type] # noqa: E501
                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 123, in await_only
    raise exc.MissingGreenlet(
sqlalchemy.exc.MissingGreenlet: greenlet_spawn has not been called; can't call await_only() here. Was IO attempted in an unexpected place? (Background on this error at: https://sqlalche.me/e/20/xd2s)
=============================== warnings summary ===============================
backend/app/schemas/user.py:42
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/user.py:42: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserResponse(UserBase):

backend/app/schemas/strategy.py:39
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/strategy.py:39: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class StrategyResponse(StrategyBase):

backend/app/schemas/strategy.py:69
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/strategy.py:69: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class StrategyTickerResponse(StrategyTickerBase):

backend/app/schemas/strategy.py:95
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/strategy.py:95: PydanticDeprecatedSince20: `min_items` is deprecated and will be removed, use `min_length` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    tickers: List[str] = Field(

backend/app/schemas/trade.py:31
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/trade.py:31: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TradeResponse(TradeBase):

backend/app/schemas/trade.py:55
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/trade.py:55: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PositionResponse(PositionBase):

../../.pyenv/versions/3.12.1/lib/python3.12/site-packages/websockets/legacy/__init__.py:6
  /Users/ashwin/.pyenv/versions/3.12.1/lib/python3.12/site-packages/websockets/legacy/__init__.py:6: DeprecationWarning: websockets.legacy is deprecated; see https://websockets.readthedocs.io/en/stable/howto/upgrade.html for upgrade instructions
    warnings.warn(  # deprecated in 14.0 - 2024-11-09

backend/app/schemas/risk_rule.py:40
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/risk_rule.py:40: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class RiskRuleResponse(RiskRuleBase):

backend/app/schemas/order.py:32
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/order.py:32: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class OrderResponse(OrderBase):

backend/app/schemas/api_key.py:39
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/api_key.py:39: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ApiKeyResponse(ApiKeyBase):

backend/app/schemas/api_key.py:81
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/api_key.py:81: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ApiKeyAuditLogResponse(BaseModel):

backend/app/schemas/notification.py:32
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/notification.py:32: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class NotificationResponse(NotificationBase):

backend/app/schemas/notification.py:83
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/notification.py:83: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class NotificationPreferenceResponse(NotificationPreferenceBase):

backend/app/schemas/optimizer.py:12
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/optimizer.py:12: PydanticDeprecatedSince20: `min_items` is deprecated and will be removed, use `min_length` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    symbols: List[str] = Field(

backend/app/schemas/optimizer.py:12
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/optimizer.py:12: PydanticDeprecatedSince20: `max_items` is deprecated and will be removed, use `max_length` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    symbols: List[str] = Field(

backend/app/schemas/optimizer.py:37
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/optimizer.py:37: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class StrategyPerformanceSchema(BaseModel):

backend/app/schemas/optimizer.py:56
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/optimizer.py:56: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class OptimizationResultSchema(BaseModel):

backend/app/schemas/portfolio.py:40
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/portfolio.py:40: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PerformanceMetricsResponse(BaseModel):

backend/app/schemas/portfolio.py:102
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/portfolio.py:102: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TaxLotResponse(BaseModel):

backend/app/schemas/watchlist.py:27
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/watchlist.py:27: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class WatchlistItemResponse(BaseModel):

backend/app/schemas/watchlist.py:44
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/watchlist.py:44: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class WatchlistResponse(BaseModel):

backend/app/schemas/watchlist.py:74
  /Users/ashwin/Desktop/algo-trading-app/backend/app/schemas/watchlist.py:74: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PriceAlertResponse(BaseModel):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED backend/tests/test_backtesting_e2e.py::test_backtest_e2e_flow - sqlalc...
======================== 1 failed, 22 warnings in 1.01s ========================
